<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Midpoint Finder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #map {
            height: 400px;
            margin-top: 20px;
        }
        input, button {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
        }
        #result {
            margin-top: 20px;
        }
        .error {
            color: red;
            margin-top: 10px;
        }
        .loading {
            display: none;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Enhanced SweetSpot Finder</h1>
    <div>
        <input type="text" id="city1" placeholder="Enter first city" aria-label="First city">
        <input type="text" id="city2" placeholder="Enter second city" aria-label="Second city">
        <button onclick="findMidpoint()" aria-label="Find best location to meet">Find best location to meet</button>
    </div>
    <div class="loading" id="loading">Calculating...</div>
    <div class="error" id="error"></div>
    <div id="map"></div>
    <div id="result"></div>

    <script>
        // ... (previous map initialization and geocoding functions) ...

        async function findMidpoint() {
            const city1 = document.getElementById('city1').value.trim();
            const city2 = document.getElementById('city2').value.trim();
            const errorDiv = document.getElementById('error');
            const loadingDiv = document.getElementById('loading');

            errorDiv.textContent = '';
            loadingDiv.style.display = 'block';

            if (!city1 || !city2) {
                errorDiv.textContent = 'Please enter both cities.';
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                const coords1 = await geocode(city1);
                const coords2 = await geocode(city2);
                const mid = midpoint(coords1.lat, coords1.lon, coords2.lat, coords2.lon);

                // Clear previous markers and add new ones
                // ... (previous marker code) ...

                // Add a polyline connecting the cities and midpoint
                const polyline = L.polyline([
                    [coords1.lat, coords1.lon],
                    [mid.lat, mid.lon],
                    [coords2.lat, coords2.lon]
                ], {color: 'red'}).addTo(map);

                // Fit map to show all markers and the polyline
                const group = new L.featureGroup([...markers, polyline]);
                map.fitBounds(group.getBounds().pad(0.1));

                // Calculate distances
                const distance1 = calculateDistance(coords1, mid);
                const distance2 = calculateDistance(coords2, mid);

                // Display enhanced result
                document.getElementById('result').innerHTML = `
                    <h2>Results:</h2>
                    <p>${city1}: ${coords1.lat.toFixed(4)}, ${coords1.lon.toFixed(4)}</p>
                    <p>${city2}: ${coords2.lat.toFixed(4)}, ${coords2.lon.toFixed(4)}</p>
                    <p>Midpoint: ${mid.lat.toFixed(4)}, ${mid.lon.toFixed(4)}</p>
                    <p>Distance from ${city1} to midpoint: ${distance1.toFixed(2)} km</p>
                    <p>Distance from ${city2} to midpoint: ${distance2.toFixed(2)} km</p>
                    <button onclick="shareResults()">Share Results</button>
                `;
            } catch (error) {
                errorDiv.textContent = error.message;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function calculateDistance(coord1, coord2) {
            // Haversine formula to calculate distance between two points
            const R = 6371; // Earth's radius in km
            const dLat = (coord2.lat - coord1.lat) * Math.PI / 180;
            const dLon = (coord2.lon - coord1.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(coord1.lat * Math.PI / 180) * Math.cos(coord2.lat * Math.PI / 180) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function shareResults() {
            // Implement sharing functionality (e.g., generate a shareable link)
            alert('Sharing functionality to be implemented');
        }

        initMap();
    </script>
</body>
</html>
